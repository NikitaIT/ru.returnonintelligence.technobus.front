'use strict';

/**
 * Модуль карты
 * @param {object} function ( Инициализация карты
 */
$(function () {
  /**
   * Инициализация карты
   */
  function init() {
    var places = {
      metro: [59.853876, 30.321102],
      technopolis: [59.818043, 30.327938],
      metro1: [59.850127, 30.321772],
      routeCenter: [59.835681, 30.322253]
    };
    var from = places.metro,
        to = places.technopolis;
    var myMap = new ymaps.Map('map', {
      center: places.metro,
      zoom: 16
    }, {
      searchControlProvider: 'yandex#search'

    }),
        myPlacemark = new ymaps.Placemark(myMap.getCenter());

    myMap.geoObjects.add(myPlacemark);
    var myRoute = void 0;

    function addRoute(from, to) {
      ymaps.route([{
        point: from,
        type: 'viaPoint'
      }, to]).then(function (route) {
        myMap.geoObjects.add(myRoute = route);
      }, function (error) {
        console.error('Возникла ошибка: ' + error.message);
      });
    };

    var routeButton = new ymaps.control.Button('<i class="fa fa-bus" style="color: dimgray"></i>');

    routeButton.events.add('select', function () {
      addRoute(from, to);
      myMap.setZoom(12);
      myMap.setCenter(places.routeCenter);
    }).add('deselect', function () {
      myRoute && myMap.geoObjects.remove(myRoute);
    });

    myMap.controls.add(routeButton, { float: 'left', maxWidth: 'auto' });

    myPlacemark.events.add('mouseenter', function (e) {
      // Ссылку на объект, вызвавший событие,
      // можно получить из поля 'target'.
      e.get('target').options.set('preset', 'islands#greenIcon');
    }).add('mouseleave', function (e) {
      e.get('target').options.unset('preset');
    });

    function changeRoute() {
      if (routeButton.isSelected()) {
        myRoute && myMap.geoObjects.remove(myRoute);
        addRoute(from, to);
      }
    };

    $(".from_technopolis").click(function () {
      myMap.setCenter(places.technopolis);
      myPlacemark.geometry.setCoordinates(myMap.getCenter());
      from = places.technopolis;
      to = places.metro1;
      changeRoute();
      myMap.setZoom(16);
    });

    $(".to_technopolis").click(function () {
      myMap.setCenter(places.metro);
      myPlacemark.geometry.setCoordinates(myMap.getCenter());
      from = places.metro;
      to = places.technopolis;
      changeRoute();
      myMap.setZoom(16);
    });
  }

  ymaps.ready(init);
});
"use strict";

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

/**
 * Модуль работы с гугл таблицами
 */
$(function googleApi() {
	var API = function () {
		function API(tableViewer, url) {
			_classCallCheck(this, API);

			this.url = url;
			this.tableViewer = tableViewer;
			this.googleSpreadsheet = new GoogleSpreadsheet();
			if (localStorage.length == 0 || localStorage.getItem(0) == null || localStorage.getItem(1) == null) {
				this.saveToLocalStorage();
				console.log("first saveToLocalStorage()");
			} else {
				console.log("first showTimetable()");
				this.showTimetable();
				if (navigator.onLine) {
					console.log("onLine updateStorage()");
					this.updateStorage();
				};
			}
		}
		/**
   * Запрашивает с апи гугла таблицу по урлу
   * @param {string} url Адрес листа таблицы
   * @param {function} fun Что с ней делает
   */


		_createClass(API, [{
			key: "googleSpreadsheetLoad",
			value: function googleSpreadsheetLoad(url, fun) {
				this.googleSpreadsheet.url(url);
				this.googleSpreadsheet.load(function (result) {
					console.log("\u0417\u0430\u0433\u0440\u0443\u0436\u0435\u043D \u043E\u0431\u044C\u0435\u043A\u0442:", result);
					fun(result);
				});
			}
			/**
    * Сохранение расписания в локальное хранилище
    */

		}, {
			key: "saveToLocalStorage",
			value: function saveToLocalStorage() {
				var _this = this;

				this.googleSpreadsheetLoad(url, function (result) {
					console.log(result);
					localStorage.setItem(0, JSON.stringify(result));
					_this.tableViewer.addTableList(result, 0);
				});
				this.googleSpreadsheetLoad(url + "&gid=1453141125", function (result) {
					localStorage.setItem(1, JSON.stringify(result));
					_this.tableViewer.addTableList(result, 1);
				});
				this.googleSpreadsheetLoad(url + "&gid=135110459", function (result) {
					_this.tableViewer.addInfoList(result);
				});
				localStorage.setItem('DATE', Date());
			}
			/**
    * Обновление
    */

		}, {
			key: "updateStorage",
			value: function updateStorage() {
				this.tableViewer.cleanTableList();
				this.saveToLocalStorage();
			}
		}, {
			key: "showTimetable",
			value: function showTimetable() {
				this.tableViewer.addTableList(JSON.parse(localStorage.getItem(0)), 0);
				this.tableViewer.addTableList(JSON.parse(localStorage.getItem(1)), 1);
			}
		}]);

		return API;
	}();

	var TableViewer = function () {
		function TableViewer(timetableRowClass, infoClass) {
			_classCallCheck(this, TableViewer);

			this.timetableRowClass = timetableRowClass;
			this.infoClass = infoClass;
		}
		/**
  * Добавляет информанию из таблицы
  * @param {object}   infoJSON  Обьект
  * @param {string} infoClass Класс в который добавляем
  */


		_createClass(TableViewer, [{
			key: "addInfoList",
			value: function addInfoList(infoJSON) {
				console.log("f: addTableList(infoJSON=", infoJSON, ", infoClass= " + this.infoClass + ")");
				var infoHtmlString = "";
				infoJSON.items.forEach(function (msg) {
					infoHtmlString += "<p class=\"info-list--elem\">\n\t\t\t\t\t\t\t\t\t<span class=\"info-list--elem__title\">\n\t\t\t\t\t\t\t\t\t\t" + msg.id + "\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t" + msg.info + "\n\t\t\t\t\t\t\t\t</p>";
				});
				$(this.infoClass).append(infoHtmlString);
			}
			/**
   * Add table list in timetable
   * @param   {object} timetableJSON     Data
   * @param   {string} timetableRowClass Table DOM class
   * @param   {number} id                Table list number
   */

		}, {
			key: "addTableList",
			value: function addTableList(timetableJSON, id) {
				console.log("f: addTableList(id=" + id + ", timetableJSON=", timetableJSON, ", timetableRowClass= " + this.timetableRowClass + ")");
				var minMap = {
					"b": "00",
					"c": "05",
					"d": 10,
					"e": 15,
					"f": 20,
					"g": 25,
					"h": 30,
					"i": 35,
					"j": 40,
					"k": 45,
					"l": 50,
					"m": 55
				};
				var timetableRowHtmlString = "<div class=\"timetable__row__current\" id=\"route" + id + "\">";
				timetableJSON.items.forEach(function (mins) {
					var minHtmlString = getMinHtmlString(mins);
					if (minHtmlString !== "") {
						timetableRowHtmlString += "<div class=\"timetable__row\">\n\t\t\t\t\t\t\t\t<div class=\"timetable__hover\">\n\t\t\t\t\t\t\t\t\t" + mins.id + "\t\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<hr class=\"line\"/>\n\t\t\t\t\t\t\t\t<div class=\"timetable__row--subrow\">\n\t\t\t\t\t\t\t\t\t" + minHtmlString + "\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>";
					}
				});
				timetableRowHtmlString += '</div>';

				/**
     * Добавляет строку минут в таблицу
     * @param   {object} mins Массив пар (Минуты:День,Id:Часы)
     * @returns {string} Строковое представление в таблице
     */
				function getMinHtmlString(mins) {
					var minsHtmlString = "";
					for (var min in mins) {
						if (minMap[min] == undefined) continue;
						minsHtmlString += "<div  class=\"timetable__min " + getDayClassName(mins[min]) + "\">\n\t\t\t\t\t\t\t\t" + mins.id + ":" + minMap[min] + "\n\t\t\t\t\t\t\t</div>";
					}
					return minsHtmlString;
					/**
      * Добавляет класс дня недели
      * @param   {string} tableDayName Название дня недели в таблице exel
      * @returns {string}   Класс дня недели
      */
					function getDayClassName(tableDayName) {
						var daysInTable = ['Su', 'Mo', 'Tu', 'Te', 'Th', 'Fr', 'Sa', 'All'];
						var daysExtendtion = [].concat(_toConsumableArray(days), ["All"]);
						if (daysInTable.indexOf(tableDayName) === undefined) {
							console.error("tableDayName is undefined, \n\t\t\t\t\t\t\t\t\tcur: " + tableDayName + " \n\t\t\t\t\t\t\t\t\texp: " + daysExtendtion + "\n\t\t\t\t\t\t\t\t\t");
							return ' ';
						}
						return ' day-' + daysExtendtion[daysInTable.indexOf(tableDayName)];
					}
				}

				$(this.timetableRowClass).append(timetableRowHtmlString);
			}
		}, {
			key: "cleanTableList",
			value: function cleanTableList() {
				$(this.timetableRowClass).html("");
			}
		}, {
			key: "cleanInfoList",
			value: function cleanInfoList() {
				$(this.infoClass).html("");
			}
		}]);

		return TableViewer;
	}();

	;
	var url = "https://docs.google.com/spreadsheet/pub?key=1VwgzSFxVRu2Z-9tvF8wimO2m3BmuW4ngcST5uGSRYRg&output=html";
	var tableViewer = new TableViewer(".timetable__row__all", ".info-list");
	var apiObj = new API(tableViewer, url);
	setLanguage("ru");
});
'use strict';

var days = ['sunday', 'monday', 'tuesday', 'tednesday', 'thursday', 'friday', 'saturday'];
var fullDays = ['fullSunday', 'fullMonday', 'fullTuesday', 'fullTednesday', 'fullThursday', 'fullFriday', 'fullSaturday'];

/**
 * Установка языка сайта
 * @param {string} lang Пользовательская локаль
 */
function setLanguage(lang) {
	$.getJSON('lang/' + lang + '.json', function (data) {
		$.each(data, function (key, val) {
			$('[name = ' + key + ']').html(val);
		});
	});
}
$(function () {
	// Установка времени показа заставки
	$(".preloader").delay(1000).fadeOut("slow");

	// Отрисовка боковой панели 
	(function () {
		var strDOM = "";
		days.forEach(function (day, i) {
			strDOM += '<div class="panel--button panel--button-' + i + ' day-' + day + '">\n\t\t\t\t\t\t<span name="' + day + '"></span>\n\t\t\t\t\t</div>';
		});
		$(".panel").append(strDOM);
	})();
});
/**
 * Модуль установки событий работы с свичём
 */
$(function () {
	$(".russian").button('toggle');
	$(".russian").click(function () {
		setLanguage("ru");
		$('#map').attr('lang', 'ru');
	});
	$(".russian").click();
	$(".english").click(function () {
		setLanguage("en");
		$('#map').attr('lang', 'en');
	});
	$(".lang").addClass("btn-group-vertical");
	$(".lang").removeClass("btn-group");
	$(".to_technopolis").button('toggle');
	$(".to_technopolis").click(function () {
		$("#route0").css("visibility", "visible");
		$("#route0").css("position", "initial");
		$("#route1").css("visibility", "hidden");
		$("#route1").css("position", "absolute");
	});
	$(".from_technopolis").click(function () {
		$("#route0").css("visibility", "hidden");
		$("#route0").css("position", "absolute");
		$("#route1").css("visibility", "visible");
		$("#route1").css("position", "initial");
	});
});
/**
 * Модуль работы с датой
 */
$(function () {
	/**
  * Установка текущей даты, поиск следующей даты в таблице
  */
	function setDate() {
		var options = {
			hour: 'numeric',
			minute: 'numeric'
		};
		function getWeekDay(date) {
			return fullDays[date.getDay()];
		}
		var date = new Date();
		$(".day").attr('name', getWeekDay(date));
		$("time.current-time").html(date.toLocaleString('ru', options) + ' ');

		Number.prototype.div = function (by) {
			return (this - this % by) / by;
		};
		var minTmp = date.getMinutes();
		minTmp = minTmp >= 10 ? minTmp.div(10) + 1 + "0" : "10";
		$('.timetable__min:contains(' + date.getHours() + ':' + minTmp + ')').css('border', '2px solid green');
	}
	setDate();
	setInterval(setDate, 9000);
});

//    
//    //Сохранение документа с расписанием
//    function download(text, name, type) {
//        var a = document.createElement("a");
//        var file = new Blob([text], {type: type});
//        a.href = URL.createObjectURL(file);
//        a.download = name;
//        a.click();
//    }